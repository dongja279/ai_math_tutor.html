<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI ìˆ˜í•™ íŠœí„° â€” ì‚¬ì§„ë§Œ ì˜¬ë¦¬ë©´ ë°”ë¡œ í’€ì´</title>
<link rel="preconnect" href="https://api.openai.com">
<style>
  :root{
    --bg:#0e1116; --panel:#141922; --panel2:#0f1520; --ink:#e8eef7;
    --muted:#98a2b3; --accent:#8b5cf6; --accent2:#06b6d4; --line:#1f2937; --chip:#1b2230;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f9fc; --panel:#ffffff; --panel2:#ffffff; --ink:#202734;
           --muted:#58647a; --accent:#6d28d9; --accent2:#0891b2; --line:#e7edf5; --chip:#f2f6fc; }
  }
  *{box-sizing:border-box}
  body{margin:0;color:var(--ink);background:var(--bg);
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#131a25cc,#0f1520cc);
    border-bottom:1px solid #ffffff14;color:#fff;backdrop-filter:blur(8px)}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:50%;background:conic-gradient(from 140deg,var(--accent),var(--accent2))}
  .brand h1{margin:0;font-size:18px}
  .brand small{display:block;color:#cfe1ff;font-weight:500}
  main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:16px}
  .grid{display:grid;gap:16px} @media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;padding:16px}
  .panel h2{margin:0 0 10px;color:#b8c3d6;font-size:14px}
  .uploader{display:flex;gap:10px}.uploader .btn{flex:1} @media(max-width:520px){.uploader{flex-direction:column}}
  .btn{cursor:pointer;border:none;border-radius:12px;padding:13px 16px;font-weight:800;background:#1b2230;color:#e8eef7;transition:.2s}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
  .btn.soft{background:var(--chip);color:var(--ink);border:1px solid var(--line)}
  .btn.small{padding:8px 10px}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  select{width:100%;background:var(--chip);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:12px}
  .meter{height:8px;background:#0f1623;border-radius:999px;overflow:hidden;border:1px solid #ffffff16}
  .meter>div{height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#a78bfa,#22c55e)}
  #canvasWrap{border:1px dashed #89a3c91f;border-radius:14px;overflow:hidden;background:#0f172a;min-height:220px}
  #imgCanvas{display:block;width:100%} .empty{display:flex;align-items:center;justify-content:center;height:220px;color:#94a3b8}
  #chat .bubble{margin:12px 0;padding:16px;border-radius:14px;border:1px solid #ffffff17;background:#0f1623;color:#e7efff}
  #chat .bubble header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .copy{border:1px solid #ffffff24;background:#101727;color:#e6eeff;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input[type=file]{display:none}
  .status{font-size:12px;color:#9fb1c8;margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="container brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>AI ìˆ˜í•™ íŠœí„°</h1>
      <small>ì‚¬ì§„ë§Œ ì˜¬ë¦¬ë©´ <b>ë°”ë¡œ í’€ì´</b>! </small>
    </div>
  </div>
</header>

<main class="grid">
  <!-- ì¢Œ: ì—…ë¡œë“œ/ìƒíƒœ -->
  <section class="panel">
    <h2>ë¬¸ì œ ì‚¬ì§„ ì—…ë¡œë“œ</h2>
    <div class="uploader" style="margin-top:6px">
      <input id="imageGallery" type="file" accept="image/*">
      <button id="btnGallery" class="btn soft" type="button">ğŸ–¼ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</button>
      <input id="imageCamera" type="file" accept="image/*" capture="environment">
      <button id="btnCamera" class="btn primary" type="button">ğŸ“· ì¹´ë©”ë¼ë¡œ ì°ê¸°</button>
    </div>

    <div style="margin-top:14px">
      <label>ëª¨ë¸</label>
      <select id="model">
        <option value="gpt-4o-mini" selected>gpt-4o-mini (ë¹ ë¦„)</option>
        <option value="gpt-4o">gpt-4o (ì •í™•)</option>
      </select>
    </div>

    <div style="margin-top:14px">
      <label>ì§„í–‰ ìƒí™©</label>
      <div class="meter"><div id="meterBar"></div></div>
      <div id="status" class="status">ëŒ€ê¸° ì¤‘â€¦</div>
    </div>
  </section>

  <!-- ìš°: ë¯¸ë¦¬ë³´ê¸° + ê²°ê³¼ -->
  <section class="panel">
    <h2>ë¯¸ë¦¬ë³´ê¸° & ê²°ê³¼</h2>
    <div id="canvasWrap" style="margin-top:8px">
      <div id="emptyMsg" class="empty">ğŸ“· ì•„ì§ ì‚¬ì§„ì´ ì—†ì–´ìš”. ìœ„ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì°ì–´ ì£¼ì„¸ìš”.</div>
      <canvas id="imgCanvas"></canvas>
    </div>
    <div id="chat"></div>
  </section>
</main>

<script>
/* ===== DOM ===== */
const inputGallery = document.getElementById("imageGallery");
const inputCamera  = document.getElementById("imageCamera");
const btnGallery   = document.getElementById("btnGallery");
const btnCamera    = document.getElementById("btnCamera");
const modelSelect  = document.getElementById("model");
const canvas = document.getElementById("imgCanvas");
const emptyMsg = document.getElementById("emptyMsg");
const ctx = canvas.getContext("2d");
const chat = document.getElementById("chat");
const meterBar = document.getElementById("meterBar");
const statusEl = document.getElementById("status");

/* ===== ìƒíƒœ ===== */
let imageDataUrl = null;
let busy = false;

/* ===== ì—…ë¡œë“œ íŠ¸ë¦¬ê±° ===== */
btnGallery.addEventListener("click", ()=> inputGallery.click());
btnCamera .addEventListener("click", ()=> inputCamera.click());

[inputGallery, inputCamera].forEach(inp=>{
  inp.addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    await drawImageOnCanvas(file);
    chat.innerHTML = "";
    await solve(false);  // ì—…ë¡œë“œ ì¦‰ì‹œ í’€ì´
    e.target.value = "";
  });
});

/* ===== UI ìœ í‹¸ ===== */
function setBusy(b, msg){
  busy = b;
  statusEl.textContent = b ? (msg || "AIê°€ í’€ì´ ì¤‘â€¦") : "ëŒ€ê¸° ì¤‘â€¦";
  meterBar.style.width = b ? "70%" : "0%";
  [btnGallery, btnCamera].forEach(bn => bn.disabled = b);
}
function bubble(title, html, withActions=false){
  const box = document.createElement("div");
  box.className = "bubble";
  box.innerHTML = `
    <header>
      <strong>${title}</strong>
      <button class="copy" onclick="copyMe(this)">ë³µì‚¬</button>
    </header>
    <div class="copy-target">${(html||"").replaceAll("\n","<br>")}</div>
  `;
  if(withActions){
    const actions = document.createElement("div");
    actions.className = "actions";
    const retry = document.createElement("button");
    retry.className = "btn soft";
    retry.textContent = "ğŸ” ë‹¤ì‹œí’€ê¸°";
    retry.onclick = ()=> solve(true);
    actions.appendChild(retry);
    box.appendChild(actions);
  }
  chat.appendChild(box);
  chat.scrollTop = chat.scrollHeight;
}
window.copyMe = (btn)=>{
  const txt = btn.parentElement.nextElementSibling.innerText;
  navigator.clipboard.writeText(txt).then(()=>{
    const old = btn.textContent; btn.textContent = "âœ… ë³µì‚¬ë¨"; setTimeout(()=>btn.textContent=old,1200);
  });
};

/* ===== ìº”ë²„ìŠ¤: í¬ê¸° ì¤„ì—¬ ì—…ë¡œë“œ(ìš©ëŸ‰ ì ˆê°) ===== */
function drawImageOnCanvas(file){
  return new Promise((resolve)=>{
    const r = new FileReader();
    r.onload = ev=>{
      const srcUrl = ev.target.result;
      const img = new Image();
      img.onload = ()=>{
        emptyMsg.style.display = "none";
        const maxW = canvas.parentElement.clientWidth;
        const scale = Math.min(1, maxW/img.width);
        canvas.width = Math.floor(img.width*scale);
        canvas.height= Math.floor(img.height*scale);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        // ì••ì¶•ë³¸ dataURLë¡œ êµì²´ (ì „ì†¡ìš©ëŸ‰â†“)
        imageDataUrl = canvas.toDataURL('image/jpeg', 0.85);
        resolve();
      };
      img.src = srcUrl;
    };
    r.readAsDataURL(file);
  });
}

/* ===== ì„œë²„ë¦¬ìŠ¤ API í˜¸ì¶œ ===== */
async function callBackend({retry=false}={}){
  const res = await fetch('/api/solve',{
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ imageDataUrl, model: modelSelect.value, retry })
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`HTTP ${res.status}: ${t}`);
  }
  return res.json();
}

/* ===== ì‹¤í–‰ ===== */
async function solve(retry=false){
  if(!imageDataUrl){ return; }
  try{
    setBusy(true, retry ? "ë‹¤ì‹œ í’€ì–´ë³´ëŠ” ì¤‘â€¦" : "AIê°€ í’€ì´ ì¤‘â€¦");
    const { answer } = await callBackend({ retry });
    bubble(retry ? "ì¬í’€ì´ ê²°ê³¼" : "í’€ì´ & ì •ë‹µ", answer, true);
    setBusy(false, "");
    meterBar.style.width = "100%"; statusEl.textContent = "ì™„ë£Œ!";
  }catch(e){
    setBusy(false, ""); bubble("ì˜¤ë¥˜", e.message || "ìš”ì²­ ì¤‘ ì˜¤ë¥˜");
  }
}

/* ì´ˆê¸° ì•ˆë‚´ */
bubble("ì•ˆë‚´","ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ ì œê°€ <b>ë°”ë¡œ í’€ì´</b>í•´ìš”. ê²°ê³¼ê°€ ì´ìƒí•˜ë©´ ì•„ë˜ <b>ë‹¤ì‹œí’€ê¸°</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ê´€ì ìœ¼ë¡œ ì¬ê²€í† í•  ìˆ˜ ìˆì–´ìš”.");
</script>
</body>
</html>
